from zai import ZaiClient
import os
import json
from dotenv import load_dotenv

load_dotenv()

SYSTEM_PROMPT_CLIMATE = """
–¢—ã ‚Äî –≤—ã—Å–æ–∫–æ—Ç–æ—á–Ω—ã–π –∫–ª–∏–º–∞—Ç–∏—á–µ—Å–∫–∏–π API, –∫–æ—Ç–æ—Ä—ã–π –æ—Ç–≤–µ—á–∞–µ—Ç –∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON.
–¢–≤–æ–π –æ—Ç–≤–µ—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–∞–ª–∏–¥–Ω—ã–º JSON –æ–±—ä–µ–∫—Ç–æ–º.
–¢—ã –Ω–µ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Markdown –∏–ª–∏ –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Ñ–æ—Ä–º–∞—Ç—ã.
–¢—ã –Ω–µ –¥–æ–ª–∂–µ–Ω –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ``` –≤ –Ω–∞—á–∞–ª–µ –∏ –≤ –∫–æ–Ω—Ü–µ –æ—Ç–≤–µ—Ç–∞.

–ñ–Å–°–¢–ö–û–ï –ü–†–ê–í–ò–õ–û:
1. –ù–ï –ü–ò–®–ò –Ω–∏–∫–∞–∫–∏—Ö –æ–±—ä—è—Å–Ω–µ–Ω–∏–π, –≤–≤–æ–¥–Ω—ã—Ö —Ñ—Ä–∞–∑ –∏–ª–∏ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –î–û –∏–ª–∏ –ü–û–°–õ–ï JSON.
2. –í –æ—Ç–≤–µ—Ç–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –¢–û–õ–¨–ö–û –û–î–ò–ù JSON –æ–±—ä–µ–∫—Ç.

–°–¢–†–£–ö–¢–£–†–ê JSON (–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è):
{
  "statusMessage": "–í—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ, –æ–ø–∏—Å–∞–Ω–∏–µ –æ—à–∏–±–∫–∏ –∏–ª–∏ –Ω–µ –¥–æ—Å—Ç–∞—é—â–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏",
  "statusCode": "0 - —É—Å–ø–µ—Ö, 1 - –æ—à–∏–±–∫–∞",
  "city": "–ù–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞ (—Å—Ç—Ä–æ–∫–∞)",
  "unit": "–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è (—Å—Ç—Ä–æ–∫–∞, –Ω–∞–ø—Ä–∏–º–µ—Ä, –¶–µ–ª—å—Å–∏–π)",
  "source": "–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö (—Å—Ç—Ä–æ–∫–∞)",
  "temperatures": {
    "–Ω–∞–∑–≤–∞–Ω–∏–µ_–º–µ—Å—è—Ü–∞_–≤_–∞–Ω–≥–ª_–Ω_—Ä–µ–≥–∏—Å—Ç—Ä–µ": {
      "ru": "–†—É—Å—Å–∫–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–µ—Å—è—Ü–∞ (—Å—Ç—Ä–æ–∫–∞)",
      "avg_temp": "–°—Ä–µ–¥–Ω—è—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ (—á–∏—Å–ª–æ —Å –ø–ª–∞–≤–∞—é—â–µ–π —Ç–æ—á–∫–æ–π)"
    }
    // ... –∏ —Ç–∞–∫ –¥–ª—è –≤—Å–µ—Ö 12 –º–µ—Å—è—Ü–µ–≤.
  }
}
"""

SYSTEM_PROMPT_EXPERT = """
–¢—ã ‚Äî ¬´**–ì–∞—Å—Ç—Ä–æ–ì–∏–¥**¬ª, —ç–∫—Å–ø–µ—Ä—Ç –∏ –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø–æ–¥–±–æ—Ä—É –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∏ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–æ–≤, –∫–∞—Ñ–µ –∏ –±–∞—Ä–æ–≤ –≤ —É–∫–∞–∑–∞–Ω–Ω–æ–º –≥–æ—Ä–æ–¥–µ. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî —Å–æ–±—Ä–∞—Ç—å –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏—è—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –∑–∞–¥–∞–≤–∞—è –≤–æ–ø—Ä–æ—Å—ã **—Å—Ç—Ä–æ–≥–æ –ø–æ—ç—Ç–∞–ø–Ω–æ**, –æ–¥–∏–Ω –∑–∞ –¥—Ä—É–≥–∏–º, –∏ –ª–∏—à—å –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –∑–∞–≤–µ–¥–µ–Ω–∏–π.

### üìù –≠—Ç–∞–ø—ã —Ä–∞–±–æ—Ç—ã:
1.  **–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –ì–æ—Ä–æ–¥:** –ü–æ–∑–¥–æ—Ä–æ–≤–∞–π—Å—è, –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è (–∫–∞–∫ –ì–∞—Å—Ç—Ä–æ–ì–∏–¥) –∏ –ø–æ–ø—Ä–æ—Å–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **—É–∫–∞–∑–∞—Ç—å –≥–æ—Ä–æ–¥**, –≤ –∫–æ—Ç–æ—Ä–æ–º –æ–Ω –∏—â–µ—Ç –∑–∞–≤–µ–¥–µ–Ω–∏–µ.
2.  **–£—Ç–æ—á–Ω—è—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã (—Å—Ç—Ä–æ–≥–æ –ø–æ –ø–æ—Ä—è–¥–∫—É):** –ó–∞–¥–∞–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–ª–µ–¥—É—é—â–∏–µ —Ç—Ä–∏ –≤–æ–ø—Ä–æ—Å–∞, –ø–æ–ª—É—á–∞—è –æ—Ç–≤–µ—Ç –Ω–∞ –∫–∞–∂–¥—ã–π, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É:
    * **–í–æ–ø—Ä–æ—Å 1 (–ë—é–¥–∂–µ—Ç):** ¬´–ö–∞–∫–æ–π —É –≤–∞—Å –ø—Ä–∏–º–µ—Ä–Ω—ã–π **–±—é–¥–∂–µ—Ç** –Ω–∞ —á–µ–ª–æ–≤–µ–∫–∞? (–ù–∞–ø—Ä–∏–º–µ—Ä: –¥–æ 1500 —Ä—É–±., 1500-3000 —Ä—É–±., –æ—Ç 3000 —Ä—É–±.)¬ª
    * **–í–æ–ø—Ä–æ—Å 2 (–ö—É—Ö–Ω—è/–≠–∫–∑–æ—Ç–∏–∫–∞):** ¬´–ü—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ—Ç–µ –ª–∏ –≤—ã **—ç–∫–∑–æ—Ç–∏—á–µ—Å–∫—É—é –∏–ª–∏ –Ω–µ–æ–±—ã—á–Ω—É—é –∫—É—Ö–Ω—é** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä—É–∞–Ω—Å–∫—É—é, —ç—Ñ–∏–æ–ø—Å–∫—É—é, —Ñ—å—é–∂–Ω) –∏–ª–∏ —á—Ç–æ-—Ç–æ –±–æ–ª–µ–µ —Ç—Ä–∞–¥–∏—Ü–∏–æ–Ω–Ω–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∏—Ç–∞–ª—å—è–Ω—Å–∫—É—é, –≥—Ä—É–∑–∏–Ω—Å–∫—É—é, –µ–≤—Ä–æ–ø–µ–π—Å–∫—É—é)?¬ª
    * **–í–æ–ø—Ä–æ—Å 3 (–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è/–ê–ª–ª–µ—Ä–≥–∏—è):** ¬´–ï—Å—Ç—å –ª–∏ —É –≤–∞—Å **–ø–∏—â–µ–≤—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏–ª–∏ –∞–ª–ª–µ—Ä–≥–∏—è** (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≥–ª—é—Ç–µ–Ω, –ª–∞–∫—Ç–æ–∑–∞, –≤–µ–≥–µ—Ç–∞—Ä–∏–∞–Ω—Å—Ç–≤–æ)?¬ª
3.  **–£—Ç–æ—á–Ω–µ–Ω–∏—è:** –µ—Å–ª–∏ –≤ –æ—Ç–≤–µ—Ç–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å—Ç—å –∫–∞–∫–∏–µ —Ç–æ –∑–∞—Ü–µ–ø–∫–∏ –¥–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è, –∑–∞–¥–∞–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, —á—Ç–æ–±—ã —Å–æ–±—Ä–∞—Ç—å –≤—Å—é –Ω–µ–æ–±—Ö–æ–¥–∏–º—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
4.  **–§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–ø–∏—Å–∫–∞:** –ù–∞ –æ—Å–Ω–æ–≤–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤, —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞ –≤ —Å–µ—Ç–∏, —Å—Ñ–æ—Ä–º–∏—Ä—É–π –∏ –ø—Ä–µ–¥—Å—Ç–∞–≤—å **—Å–ø–∏—Å–æ–∫ –∏–∑ 3-5 –Ω–∞–∏–±–æ–ª–µ–µ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã—Ö –∑–∞–≤–µ–¥–µ–Ω–∏–π**. –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è —É–∫–∞–∂–∏:
    * –ù–∞–∑–≤–∞–Ω–∏–µ
    * –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (1-2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è)
    * –û—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–æ—á–Ω—ã–π —Å—Ä–µ–¥–Ω–∏–π —á–µ–∫
    * –ê–¥—Ä–µ—Å –∏–ª–∏ —Ä–∞–π–æ–Ω –≥–æ—Ä–æ–¥–∞ (–µ—Å–ª–∏ –≤–æ–∑–º–æ–∂–Ω–æ)
    * –û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ, –ø–æ—á–µ–º—É –æ–Ω–æ –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

–í–ê–ñ–ù–û:
 * –ï—Å–ª–∏ –ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –Ω–µ –¥–∞–µ—Ç –Ω—É–∂–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è –∏ –æ–±—ä—è—Å–Ω–∏ –∫—Ç–æ —Ç—ã —Ç–∞–∫–æ–π.
 * –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏–ª –¥–æ—Å—Ç–∞—Ç—á–æ–∂–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏, —á—Ç–æ–±—ã —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫, –∑–∞–¥–∞–π –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã.
 * –ù–µ –∑–∞—Ü–∏–∫–ª–∏–≤–∞–π –¥–∏–∞–ª–æ–≥, –µ—Å–ª–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –ø–æ–ª—É—á–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤—Å–µ –≤–æ–ø—Ä–æ—Å—ã. –ü—Ä–æ—Å—Ç–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –ª—É—á—à–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∏–º–µ—é—â–µ–π—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.
 * –í—Å–µ–≥–¥–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–π –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–æ–Ω –æ–±—â–µ–Ω–∏—è.
"""


SYSTEM_PROMPT = SYSTEM_PROMPT_EXPERT;

def validate_ai_response(response_text):
    """
    Validates the AI response by parsing it as JSON and checking if it matches the expected schema.
    """
    try:
        # Try to parse the response as JSON
        parsed_response = json.loads(response_text)

        # Define the required fields in the JSON object
        required_fields = {"statusMessage", "statusCode", "city", "unit", "source", "temperatures"}

        # Check if all required fields are present
        if not all(field in parsed_response for field in required_fields):
            print("–û—à–∏–±–∫–∞: –û—Ç–≤–µ—Ç AI –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è JSON.")
            return None

        # Validate the structure of temperatures (should be a dictionary with month objects)
        if not isinstance(parsed_response["temperatures"], dict):
            print("–û—à–∏–±–∫–∞: –ü–æ–ª–µ 'temperatures' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º —Å –º–µ—Å—è—Ü–∞–º–∏.")
            return None

        # Check if temperature objects have the correct structure
        for month_key, month_value in parsed_response["temperatures"].items():
            if not isinstance(month_value, dict):
                print(f"–û—à–∏–±–∫–∞: –ú–µ—Å—è—Ü '{month_key}' –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ–±—ä–µ–∫—Ç–æ–º.")
                return None
            if "ru" not in month_value or "avg_temp" not in month_value:
                print(f"–û—à–∏–±–∫–∞: –ú–µ—Å—è—Ü '{month_key}' –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π 'ru' –∏ 'avg_temp'.")
                return None
            if not isinstance(month_value["ru"], str):
                print(f"–û—à–∏–±–∫–∞: –ü–æ–ª–µ 'ru' –¥–ª—è –º–µ—Å—è—Ü–∞ '{month_key}' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π.")
                return None
            if not isinstance(month_value["avg_temp"], (int, float)):
                print(f"–û—à–∏–±–∫–∞: –ü–æ–ª–µ 'avg_temp' –¥–ª—è –º–µ—Å—è—Ü–∞ '{month_key}' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —á–∏—Å–ª–æ–º.")
                return None

        # Validate data types for other fields
        if not isinstance(parsed_response["statusMessage"], str):
            print("–û—à–∏–±–∫–∞: –ü–æ–ª–µ 'statusMessage' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π.")
            return None

        if not isinstance(parsed_response["statusCode"], (str, int)):
            print("–û—à–∏–±–∫–∞: –ü–æ–ª–µ 'statusCode' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π –∏–ª–∏ —á–∏—Å–ª–æ–º.")
            return None

        if not isinstance(parsed_response["city"], str):
            print("–û—à–∏–±–∫–∞: –ü–æ–ª–µ 'city' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π.")
            return None

        if not isinstance(parsed_response["unit"], str):
            print("–û—à–∏–±–∫–∞: –ü–æ–ª–µ 'unit' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π.")
            return None

        if not isinstance(parsed_response["source"], str):
            print("–û—à–∏–±–∫–∞: –ü–æ–ª–µ 'source' –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π.")
            return None

        return parsed_response

    except json.JSONDecodeError:
        print("–û—à–∏–±–∫–∞: –û—Ç–≤–µ—Ç AI –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º JSON.")
        return None
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–∞ AI: {e}")
        return None

def main():
    client = ZaiClient(api_key=os.getenv("ZAI_API_KEY"))

    print("=" * 50)
    print("–ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –∫–ª–∏–µ–Ω—Ç GLM-4.5-flash. –í–≤–µ–¥–∏—Ç–µ 'quit' –¥–ª—è –≤—ã—Ö–æ–¥–∞.")
    print("=" * 50)

    conversation = [
        {"role": "system", "content": f"{SYSTEM_PROMPT}"}
    ]

    # –û—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —á–∞—Ç–∞
    welcome_message = "–ü—Ä–∏–≤–µ—Ç, –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Å—è !"
    #print(f"\n–í—ã: {welcome_message}")
    conversation.append({"role": "user", "content": welcome_message})

    try:
        # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –º–æ–¥–µ–ª–∏
        response = client.chat.completions.create(
            model="GLM-4.5-Air",  # –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –º–æ–¥–µ–ª—å
            messages=conversation,  # –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
            temperature=0.9,
            max_tokens=2048,
            thinking={ "type": "disabled" }
            #response_format={"type": "json_object"} # –í—Ä–æ–¥–µ —É–¥–∞–ª–æ—Å—å –∏ –±–µ–∑ —ç—Ç–æ–π —à—Ç—É–∫–∏ –¥–æ–±–∏—Ç—Å—è –Ω—É–∂–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞, –Ω–æ —Å –Ω–µ–π –Ω–∞–¥–µ–∂–Ω–µ–µ
        )

        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –≤—ã–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞
        ai_response = response.choices[0].message.content

        conversation.append({"role": "assistant", "content": ai_response})
        
        # First print the raw AI response
        print(f"\nAI: {ai_response}")

    except Exception as e:
        print(f"\n –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

    while True:
        # –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        try:
            user_input = input("\n–í—ã: ")
        except (EOFError, KeyboardInterrupt):
            print("\n\n–í—ã—Ö–æ–¥.")
            break

        if user_input.lower() == 'quit':
            print("–î–æ —Å–≤–∏–¥–∞–Ω–∏—è!")
            break

        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –≤ –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞
        conversation.append({"role": "user", "content": user_input})

        try:
            # –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ –º–æ–¥–µ–ª–∏
            response = client.chat.completions.create(
                model="GLM-4.5-Air",  # –ò—Å–ø–æ–ª—å–∑—É–µ–º–∞—è –º–æ–¥–µ–ª—å
                messages=conversation,  # –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–≥–æ–≤–æ—Ä–∞
                temperature=0.9,
                max_tokens=2048,
                thinking={ "type": "disabled" }
                #response_format={"type": "json_object"} # –í—Ä–æ–¥–µ —É–¥–∞–ª–æ—Å—å –∏ –±–µ–∑ —ç—Ç–æ–π —à—Ç—É–∫–∏ –¥–æ–±–∏—Ç—Å—è –Ω—É–∂–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞, –Ω–æ —Å –Ω–µ–π –Ω–∞–¥–µ–∂–Ω–µ–µ
            )

            # –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ –≤—ã–≤–æ–¥ –æ—Ç–≤–µ—Ç–∞
            ai_response = response.choices[0].message.content
            
            conversation.append({"role": "assistant", "content": ai_response})
                                
            # First print the raw AI response
            print(f"\nAI: {ai_response}")

            # Validate the AI response
            # validated_response = validate_ai_response(ai_response)

            # if validated_response:
            #     print("–£–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç.")
            #     # Use the validated response in the conversation history
            #     conversation.append({"role": "assistant", "content": json.dumps(validated_response, ensure_ascii=False)})
            # else:
            #     print("–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–∞—Ä—Å–∏—Ç—å –æ—Ç–≤–µ—Ç.")
            #     # Optionally, you could ask the AI to try again here
            #     conversation.append({"role": "assistant", "content": ai_response})

        except Exception as e:
            print(f"\n –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    main()
